---
title: "MCT_EMAMCompetition"
author: "Claire Willing"
date: "2/9/2021"
output: github_document
---

```{r message=FALSE, warning=FALSE, include=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(grid)
library(gridExtra)
library(ggthemes)
library(lme4)
library(lmerTest)
library(cowplot)
```

Data clean-up and pre-processing
```{r message=FALSE, warning=FALSE}
setwd("~/Dropbox/Research/Postdoc/MCT_BaBi/DataAnalysis/")
MCTdataRAW=read.csv("MCT_BaBi_FullDataSheet.csv", header = T)
attach(MCTdataRAW)

#linear model
rootdrywetmassmodel<-lm(formula = Rootmass_g~Rootmass_focal_wet_g_minuspercol, data = MCTdataRAW)

library(car)
qqp(residuals(rootdrywetmassmodel), col=2)
summary(rootdrywetmassmodel)

MCTdataRAWr<-dplyr::filter(MCTdataRAW, Rootmass_focal_wet_g_minuspercol<11)

rootdrywetmassmodel<-glm(formula = Rootmass_g~Rootmass_focal_wet_g_minuspercol, data = MCTdataRAWr)

qqp(residuals(rootdrywetmassmodel), col=2)
summary(rootdrywetmassmodel)

##Row 30 is a big outlier; will try to remove and see if better fit



coefficient<-summary(rootdrywetmassmodel)



slope=coefficient$coefficients[2,1]
intercept=coefficient$coefficients[1,1]

##checking that values look correct with model fit
Rootdrywetmass<-ggplot(data=MCTdataRAWr, aes(x=Rootmass_focal_wet_g_minuspercol, y=Rootmass_g))+
  geom_point()+
  labs(title="Wet mass vs dry mass", 
       x="Wet biomass (g)",
       y="Dry biomass (g)")+
  ylim(0,3)+
  geom_abline(aes(intercept=intercept,
                  slope=slope))

Rootdrywetmass+theme_classic()

##checks out

MCTdataroot=MCTdataRAW %>%
  rowwise()%>% 
  mutate(
    ##adjustingrootsmassfromstaining
    Rootcolldry=
           (slope*Percol_wetmass_g)+intercept,
    ##roots trimmed/number of plants in pot +focal plant
    Roottrimdry=Rootmasstrimmed_g/(Competitornum+1))

##adjusted values fit on regression line?
Rootdrywetmass<-ggplot()+
  geom_point(data=MCTdataroot, aes(x=Rootmass_focal_wet_g_minuspercol, y=Rootmass_g))+
  geom_point(data=MCTdataroot, aes(x=Percol_wetmass_g, y=Rootcolldry), col="red")+
  labs(title="Wet mass vs dry mass", 
       x="Wet biomass (g)",
       y="Dry biomass (g)")+
  ylim(0,3)+
  geom_abline(aes(intercept=intercept,
                  slope=slope))
Rootdrywetmass+theme_classic()


##Clean up 
##There is one plant that was labeled as Bi, but was actually planted as Ba (Sample ID:30_EMF_BiBa0_Rep6)

MCTdatarootc<-MCTdataroot%>%
  filter(SampleIDnum==30) 

 MCTdataroot[210,]$FocalSpecies="Ba"
 MCTdataroot[210,]$SampleID="30_EMF_Ba1Ba0_Rep6"
 MCTdataroot[210,]$CompetitionTreatment="Conspecific"

 ##check to see if cleaned; good
 MCTdatarootc<-MCTdataroot%>%
  filter(SampleIDnum==30) 

#Calculating total biomass
MCTdatafull=MCTdataroot %>%
  rowwise()%>% 
  mutate_at(vars(Rootcolldry, Roottrimdry), ~replace_na(., 0))%>%
  mutate(Belowgroundbiomass_focal=
           Rootmass_g+Rootcolldry+Roottrimdry)%>%
  mutate(Abovegroundbiomass_focal=
           Shoot_leaf_mass_g+as.numeric(Amax_mass_g)
         +LMA_leafmass_g)%>% 
  mutate(Totalbiomass_focal=
  Belowgroundbiomass_focal+Abovegroundbiomass_focal)

```
Formatting
```{r}
Mycocolors = c("#D97328", "#F5C737","#B4872D", "#456947")
Compcolors= c ("#657d9a", "#8bb8d8")
```
Check out the data
```{r message=FALSE, warning=FALSE}
Fullbiomassmod<-lmer(formula = Totalbiomass_focal~FocalSpecies*CompetitionTreatment*Competitornum*Mycotreatment +(1|TrayNum), data = MCTdatafull, REML = F)

Biomassmodmin1<-lmer(formula = Totalbiomass_focal~FocalSpecies*CompetitionTreatment*Mycotreatment+Competitornum +(1|TrayNum), data = MCTdatafull, REML = F)

Biomassmodmin1b<-lmer(formula = Totalbiomass_focal~FocalSpecies*CompetitionTreatment*Competitornum +Mycotreatment +(1|TrayNum), data = MCTdatafull, REML = F)

Biomassmodmin2<-lmer(formula = Totalbiomass_focal~FocalSpecies*CompetitionTreatment+Competitornum+ Mycotreatment +(1|TrayNum), data = MCTdatafull, REML = F)


Biomassmodred<-lmer(formula = Totalbiomass_focal~FocalSpecies+CompetitionTreatment+Competitornum +Mycotreatment +(1|TrayNum), data = MCTdatafull, REML = F)

anova(Fullbiomassmod, Biomassmodmin1,Biomassmodmin1b,Biomassmodmin2, Biomassmodred)

library(sjPlot)
tab_model(Fullbiomassmod)


biomassanova<-aov(formula = Totalbiomass_focal~FocalSpecies*CompetitionTreatment*Competitornum*Mycotreatment +(1|TrayNum), data = MCTdatafull)

summary(biomassanova)
```
Plots of different factors
```{r message=FALSE, warning=FALSE}
Biomassplot<-ggplot(data=MCTdatafull, aes(x=DensityTreatment, Totalbiomass_focal))+
  geom_boxplot(aes(fill=Mycotreatment))+
  labs(title="Biomass by Treatment", 
       x="Treatment",
       y="Biomass")+facet_wrap(~FocalSpecies, scales = "free_y", 
                               ncol=1)+
  scale_fill_manual(values=Mycocolors)+
  theme(
        text = element_text(),
        panel.background = element_rect(fill="transparent", colour = NA),
        plot.background = element_rect(fill="transparent",colour = NA),
        panel.border = element_rect(fill="transparent", colour = "black"),
        axis.title.y = element_text(angle=90, size = 12, margin = margin(r=3, unit = "mm")),
        axis.title.x = element_text(size=12, margin = margin(t=3, unit = "mm")),
        axis.text.x = element_text(size=12, margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
        axis.text.y = element_text(size=12, margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
        axis.line = element_blank(),
        axis.ticks.x = element_line(colour = "black"),
        axis.ticks.y = element_line(colour = "black"),
        axis.ticks.length=unit(-1.4, "mm"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "right")






Densityplot<-ggplot(data=MCTdatafull, aes(x=Competitornum, Totalbiomass_focal))+
  geom_jitter(aes(color=CompetitionTreatment))+
  labs(title="Biomass by Treatment", 
       x="Treatment",
       y="Biomass")+facet_wrap(~FocalSpecies)
Densityplot+theme_cowplot()


Meanbiomass<-MCTdatafull %>%
  group_by(FocalSpecies, CompetitionTreatment, 
           Mycotreatment, Competitornum)%>%
  summarise(avgBiomass=mean(na.pass(Totalbiomass_focal)),
            sdBiomass=na.pass(sd(Totalbiomass_focal)))


Densityplotwmyco<-ggplot(data=na.pass(Meanbiomass), aes(x=Competitornum, avgBiomass, color=CompetitionTreatment))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=avgBiomass-sdBiomass,
                    ymax=avgBiomass+sdBiomass),
                    width=0.2)+
  labs(title="Biomass by Treatment", 
       x="Treatment",
       y="Biomass")+
  facet_wrap(~FocalSpecies+
      Mycotreatment, scales = "free_y", ncol = 2)

Densityplotwmyco+theme_base()

##Generally, Ba follows typical expected curve (higher biomass with heterospecific competition) whereas Bi typically has higher biomass with conspecific competition

#Ba is more prone to coexistence whereas Bi is more likely to be found as the dominant spp


Densityplotheterocon<-ggplot(data=na.pass(Meanbiomass), aes(x=Competitornum, avgBiomass, color=Mycotreatment))+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymin=avgBiomass-sdBiomass,
                    ymax=avgBiomass+sdBiomass),
                    width=0.2)+
  labs(title="Biomass by Treatment", 
       x="Treatment",
       y="Biomass")+
  facet_wrap(~FocalSpecies+
      CompetitionTreatment, scales = "free_y", ncol = 2)+
  scale_color_manual(values=Mycocolors)+
  theme(
        text = element_text(),
        panel.background = element_rect(fill="transparent", colour = NA),
        plot.background = element_rect(fill="transparent",colour = NA),
        panel.border = element_rect(fill="transparent", colour = "black"),
        axis.title.y = element_text(angle=90, size = 12, margin = margin(r=3, unit = "mm")),
        axis.title.x = element_text(size=12, margin = margin(t=3, unit = "mm")),
        axis.text.x = element_text(size=12, margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
        axis.text.y = element_text(size=12, margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
        axis.line = element_blank(),
        axis.ticks.x = element_line(colour = "black"),
        axis.ticks.y = element_line(colour = "black"),
        axis.ticks.length=unit(-1.4, "mm"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "right")

##some potential faciliation happening in conspecific treatment for Bi with EM; better maintenance of biomass across different densities 


# library
library(ggridges)

ridgeline<-ggplot(MCTdatafull, aes(x =as.numeric(Totalbiomass_focal), y = as.factor(Competitornum), fill= (Mycotreatment))) +
  geom_density_ridges(scale = 3,                                alpha=0.4) +
  scale_x_continuous(name = "Focal biomass (g)")+
  scale_y_discrete(name="Number of competitors")+
    #scale_fill_viridis(name = "Percol_root", option = "C") +
facet_wrap(~FocalSpecies+CompetitionTreatment, scales = "free")+
    theme(
      legend.position="right",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    )

ridgeline+theme_blank()

```

Averages
```{r message=FALSE, warning=FALSE}
M0bi_sterilefilter=Meanbiomass%>%
  filter(Competitornum==0, 
         Mycotreatment=="Sterile",
         FocalSpecies=="Bi")
M0bi_sterile=mean(M0bi_sterilefilter$avgBiomass)

M0ba_sterilefilter=Meanbiomass%>%
  filter(Competitornum==0, 
         Mycotreatment=="Sterile",
         FocalSpecies=="Ba")
M0ba_sterile=mean(M0ba_sterilefilter$avgBiomass)

##Mycotreatments w/o competition

myComparisons = list(c("AMF", "EMF"),c("AMF", "Sterile"), c("AMF", "AMFEMF"),
                     c("EMF", "Sterile"),c("EMF", "AMFEMF"), 
                     c("Sterile", "AMFEMF"))
                     
library(ggsignif)     
library(ggpubr)
No_Comp_Plot<-ggplot(data=MCTdatafull%>%filter(Competitornum==0))+
  geom_boxplot(aes(x=Mycotreatment, y=Totalbiomass_focal, 
                 fill=Mycotreatment, 
                 add = "jitter"))+
  facet_wrap(~FocalSpecies, scales="free", ncol=1)  


BiomassANOVA_nocomp_Bi<-aov(formula = Totalbiomass_focal~Mycotreatment +(1|TrayNum), data = MCTdatafull%>%filter(Competitornum==0, FocalSpecies=="Bi"))
summary(BiomassANOVA_nocomp_Bi)
TukeyHSD(BiomassANOVA_nocomp_Bi)

BiomassANOVA_nocomp_Ba<-aov(formula = Totalbiomass_focal~Mycotreatment +(1|TrayNum), data = MCTdatafull%>%filter(Competitornum==0, FocalSpecies=="Ba"))
summary(BiomassANOVA_nocomp_Ba)
TukeyHSD(BiomassANOVA_nocomp_Ba)

```
In the absence of competition, mycorrhiza and plant soil feedbacks
```{r}

tempcalc_m<-(MCTdatafull) %>%
       filter(Competitornum==0)%>%
       group_by(FocalSpecies,
               Competitornum, Mycotreatment)%>%
      summarise(
        avgmass=mean(na.exclude(Totalbiomass_focal)))

tempcalc_m %>%
  unite("FullTreatment", FocalSpecies, Mycotreatment, sep = "_", remove=F)


#Is=GrowthxHOME + GrowthyHOME -GrowthxAway-GrowthyAway

##Negative Is means both species grow worse in their own site compared to their competitors soil and thereofre plant-soil feedbacks help these species coexist

IsAMFvEMF=3.23+0.966-1.95-0.477
##IsAMFEMF=1.769; postive plant soil feedbacks; not promoting coexistence

IsAMFvsterile=3.23+0.732325-2.248673- 0.477
##IsAMFvsterile=1.236652

IsAMFEMFvEMF=3.70+0.966-1.95-0.477
##Is=2.239

IsAMFEMFvAMF=3.23+0.690-3.70-0.477
##Is=-0.257; promotes coexistence 
##This is likely the most common scenario in nature where AMF are in the background and EMF can disperse in

IsEMFvsSterile=0.966+2.248673-0.732325-1.95
##Is=0.532348








```
In the presence of competition (4 comp and 8)
```{r}

tempcalc_m4<-(MCTdatafull) %>%
       filter(Competitornum==4)%>%
       group_by(FocalSpecies,
               Competitornum, Mycotreatment)%>%
      summarise(
        avgmass=mean(na.exclude(Totalbiomass_focal)))

IsAMFvsSterile=1.67+0.361-0.377- 0.747

IsAMFvsEMF=1.67+0.650-0.377- 0.935

IsAMFEMFvEMF=1.93+0.650-0.312-0.935

IsAMFEMFvAMF=1.67+0.650-1.93-0.312

IsEMFvsSterile=0.747+0.650-0.935-0.361

##all of these are positive 


```
Only considering the microbial effect (Kandlikar 2019)
```{r}
tempcalc_m<-(MCTdatafull) %>%
       filter(Competitornum==0)%>%
       group_by(FocalSpecies,
               Competitornum, Mycotreatment)%>%
      summarise(
        avgmass=mean(na.exclude(Totalbiomass_focal)))

test<-mutate(tempcalc_alphaKandlikar, Treatment_comb = FocalSpecies + Mycotreatment)

BaSterile0=tempcalc_m%>%
  filter(Mycotreatment=="Sterile",
         FocalSpecies=="Ba")
BaSterile0=mean(BaSterile0$avgmass)

BiSterile0=tempcalc_m%>%
  filter(Mycotreatment=="Sterile",
         FocalSpecies=="Bi")
BiSterile0=mean(BiSterile0$avgmass)


mvalues<-filter(tempcalc_m, Mycotreatment == "AMF" | Mycotreatment == "EMF" | Mycotreatment == "AMFEMF" )  %>%
      mutate(
        m=
        if (FocalSpecies=="Bi"){
        log(avgmass/BiSterile0)}
        else{ 
         log(avgmass/BaSterile0)})

##1=Ba 2=Bi; 
#stabilization=-0.5*(m1a-m1b-m2a+m2b)
#fitnessdiff=-0.5*(m1a+m1b)-(1/2)*(m2a+m2b)


##AMF/EMF Ba=1
stabilization=-0.5*(0.362-(-0.144)-0.277+(-0.428))
fitnessdiff=-0.5*(0.362+(-0.144))-(1/2)*(0.277-0.428)


##AMF/AMFEMF
stabilization=-0.5*(0.362-0.499-(-0.0595)+(-0.428))
fitnessdiff=-0.5*(0.362+0.499)-(1/2)*(-0.0595+(-0.428))

##EMF/AMFEMF
stabilization=-0.5*(-0.144 -0.499-(0.277)+(-0.0595))
fitnessdiff=-0.5*(-0.144+0.499)-(1/2)*(-0.277+(-0.0595))

##when fitness<stabilization, coexistence is predicted

```

Visualizing biomass and mycorrhizal effect
```{r}
BiomasssMycoEffect<-(MCTdatafull) %>%
       filter(Mycotreatment == "AMF" | Mycotreatment == "EMF" | Mycotreatment == "AMFEMF" )%>%
       group_by(FocalSpecies,CompetitionTreatment,
               Competitornum, Mycotreatment)%>%
      summarise(
        standardizedmass=Totalbiomass_focal/sterile
          
Sterilemass<- MCTdatafull %>%
       filter(Mycotreatment == "Sterile")  %>%
        group_by(FocalSpecies,CompetitionTreatment,
               Competitornum, Mycotreatment)%>% 
        summarise(
          steriletreatmentmass=mean(Totalbiomass_focal))




```
Alpha
```{r message=FALSE, warning=FALSE}

tempcalc_alpha<-(MCTdatafull) %>%
       filter(Competitornum>0)%>%
       group_by(FocalSpecies,CompetitionTreatment,
               Competitornum, Mycotreatment)%>%
      summarise(
        avgmass=mean(na.exclude(Totalbiomass_focal)))

Alpha<-tempcalc_alpha %>%
      mutate(
        alpha=
        if (FocalSpecies=="Bi"){
        (avgmass-M0bi_sterile)/(Competitornum*M0bi_sterile)}
        else{ 
         (avgmass-M0ba_sterile)/(Competitornum*M0ba_sterile)})


##Factors
FOCAL_SPECIES_VALUES<-c("Ba", "Bi")
MYCO_TREATMENT<-c("AMF","EMF","AMFEMF","Sterile")
COMPETITOR_TREATMENT<-c("Conspecific", "Heterospecific")
COMPETITOR_NUMBER<-c("1", "4", "8")

alphatable<- data.frame("MYCO"=rep(MYCO_TREATMENT, each=3),"COMP"=rep(COMPETITOR_NUMBER, times=4), "aAB"=rep(NA, length=12),"aAA"=rep(NA, length=12),"aBA"=rep(NA, length=12),"aBB"=rep(NA, length=12), "FitnessRatio"=rep(NA, length=12), "NicheDifference"=rep(NA, length=12))

 for (i in 1:length(MYCO_TREATMENT)){
      mycotreat <- MYCO_TREATMENT[i]
    for (l in 1: length(COMPETITOR_NUMBER)){
       compnum<- COMPETITOR_NUMBER[l]
    
         aAB<-Alpha %>%
                filter(Mycotreatment==MYCO_TREATMENT[i],
                  FocalSpecies=="Ba",
                    CompetitionTreatment=="Heterospecific",
                     Competitornum==COMPETITOR_NUMBER[l])%>%
                        .$alpha
          alphatable$aAB[which(alphatable$MYCO==mycotreat 
                               & alphatable$COMP==compnum)]<-aAB
          aAA<-Alpha %>%
                        filter(Mycotreatment==MYCO_TREATMENT[i],
                          FocalSpecies=="Ba",
                            CompetitionTreatment=="Conspecific",
                             Competitornum==COMPETITOR_NUMBER[l])%>%
                                .$alpha
          alphatable$aAA[which(alphatable$MYCO==mycotreat 
                               & alphatable$COMP==compnum)]<-aAA
          
        
          aBB<-Alpha %>%
                    filter(Mycotreatment==MYCO_TREATMENT[i],
                      FocalSpecies=="Bi",
                        CompetitionTreatment=="Conspecific",
                         Competitornum==COMPETITOR_NUMBER[l])%>%
                            .$alpha
          alphatable$aBB[which(alphatable$MYCO==mycotreat 
                               & alphatable$COMP==compnum)]<-aBB
          
          aBA<-Alpha %>%
                filter(Mycotreatment==MYCO_TREATMENT[i],
                      FocalSpecies=="Bi",
                      CompetitionTreatment=="Heterospecific",
                      Competitornum==COMPETITOR_NUMBER[l])%>%
                      .$alpha
          alphatable$aBA[which(alphatable$MYCO==mycotreat
                               & alphatable$COMP==compnum)]<-aBA
            
            #Coexistence calculations with ABSOLUTE VALUES OF HETEROSPECIFICS    
            FitnessRatio<-sqrt((aAA*aAB)/(aBB*aBA))
            alphatable$FitnessRatio[which(alphatable$MYCO==mycotreat 
                               & alphatable$COMP==compnum)]<-
                                FitnessRatio
            
             NicheDifference=1-(sqrt((aBA*aAB)/(aAA*aBB)))    
        alphatable$NicheDifference[which(alphatable$MYCO==mycotreat 
                                 & alphatable$COMP==compnum)]=NicheDifference
      
             alphatable
    }
    }

            
```
Plots 
```{r}
AvgBiomass_plot<-ggplot(data=Alpha)+
  geom_point(aes(x=Competitornum, y=avgmass, 
                 color=CompetitionTreatment, shape=Mycotreatment))+
  geom_path(aes(x=Competitornum, y=avgmass, 
                color=CompetitionTreatment, shape=Mycotreatment))+
  facet_grid(FocalSpecies~Mycotreatment, scales = "free")+
  geom_hline(data=subset(Alpha,FocalSpecies=="Ba"),
             aes(yintercept = M0ba_sterile))+
  geom_hline(data=subset(Alpha,FocalSpecies=="Bi"),
             aes(yintercept = M0bi_sterile))+
  theme( text = element_text(family = "Helvetica"),
            plot.title = element_text(margin = margin(b=5, r=5, l=5, unit = "mm"),
            size = rel(0.8),
            hjust = 0.5),
            panel.background = element_rect(fill="transparent", colour = NA),
            plot.background = element_rect(fill="transparent",colour = NA),
            panel.border = element_rect(fill="transparent", colour = "black"),
            axis.title = element_text(size = rel(1)),
            axis.title.y = element_text(angle=90, size = rel(1), margin = margin(r=3, unit = "mm")),
            axis.title.x = element_text(size=rel(1), margin = margin(t=3, unit = "mm")),
            axis.text.x = element_text(size=12, margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
            axis.text.y = element_text(size=12, margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
            axis.line = element_blank(),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            legend.key = element_rect(fill="transparent", colour = NA),
            legend.key.size= unit(4, "mm"),
            legend.text = element_text(size =9),
            legend.spacing = unit(0, "mm"),
            legend.title = element_blank(),
            legend.background = element_rect(fill ="transparent", 
                                             colour = NA),
                                             strip.text = element_text(face="bold"))


Alpha_plot<-ggplot(data=Alpha)+
  geom_point(aes(x=Competitornum, y=alpha, 
                 color=CompetitionTreatment, shape=Mycotreatment))+
  geom_path(aes(x=Competitornum, y=alpha, 
                color=CompetitionTreatment, shape=Mycotreatment))+
facet_grid(FocalSpecies~Mycotreatment, scales = "free")


##"aAB represents the net competitive effect of species A on B and B on A. If soil microbes have a strong positive effect, aAB becomes greater than zerio and the plant populations grow towards infinite population size without other regulatory forces" -Ke and Wan

```

Chesson Plot 
```{r}
##Ba is Plant A, Bi is Plant B

Comp.labs <- c("1 Competitor", "4 Competitors", "8 Competitors")
names(Comp.labs) <- c("1", "4", "8")

alphatable$COMP <- factor(alphatable$COMP, levels = c("1", "4", "8"), 
                  labels = c("1 Competitor", "4 Competitors", "8 Competitors"))

fun.1=function(x) 1-x
fun.2=function(x)-(1/(x-1))

PlantComp<-ggplot() +
  geom_point(data=dplyr::filter(alphatable,COMP=="8 Competitors"), 
             aes(x=NicheDifference, y=FitnessRatio, color=MYCO))+
  labs(x =expression(paste("Niche difference ", "(1- ",rho,")")), 
       y = expression(paste("Fitness ratio ", "(", frac(f^B, f^A), ")")))+
  annotate(geom="text", x=0, y=2.5, label="Pinus wins", size=2)+
  annotate(geom="text", x=0, y=-0.5, label="Baccharis wins", size=2)+
  annotate(geom="text", x=-0.5, y=1.3, label="Priority effect", size=2)+
  annotate(geom="text", x=0.4, y=1.3, label="Coexistence", size=2)+
  stat_function(fun=fun.1, colour="black", size=0.3)+
  stat_function(fun=fun.2, color="black", size=0.3, linetype="dotted")+
  geom_area(stat = "function", fun = fun.1, xlim=c(-0.5,0), fill = "gray")+
  geom_area(stat = "function", fun = fun.2, xlim=c(0, 0.25), fill = "gray")+
  geom_vline(xintercept = 0, linetype="dashed", size=0.3)+
  geom_hline(yintercept = 1, linetype="dashed", size=0.3)+
  theme( text = element_text(family = "Helvetica"),
            plot.title = element_text(margin = margin(b=5, r=5, l=5, unit = "mm"),
            size = rel(0.8),
            hjust = 0.5),
            panel.background = element_rect(fill="transparent", colour = NA),
            plot.background = element_rect(fill="transparent",colour = NA),
            panel.border = element_rect(fill="transparent", colour = "black"),
            axis.title = element_text(size = rel(1)),
            axis.title.y = element_text(angle=90, size = rel(1), margin = margin(r=3, unit = "mm")),
            axis.title.x = element_text(size=rel(1), margin = margin(t=3, unit = "mm")),
            axis.text.x = element_text(size=12, margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
            axis.text.y = element_text(size=12, margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
            axis.line = element_blank(),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            legend.key = element_rect(fill="transparent", colour = NA),
            legend.key.size= unit(4, "mm"),
            legend.text = element_text(size =9),
            legend.spacing = unit(0, "mm"),
            legend.title = element_blank(),
            legend.background = element_rect(fill ="transparent", 
                                             colour = NA),
                                             strip.text = element_text(face="bold"))

```
Percent colonization (Bi) with different treatments
```{r}
EMcolonization<-MCTdatafull %>%
                filter(FocalSpecies=="Bi")%>%
                group_by(FocalSpecies,CompetitionTreatment,
                  Competitornum, Mycotreatment)%>%
                summarise(
                  avgcol=mean(na.exclude(as.numeric(Percol_root))),
                  sdcol=sd(na.exclude(as.numeric(Percol_root))))

MycoColonization<-c("AMFEMF","EMF")

##Does EM colonization shift with density?

colplot<-ggplot()+
  geom_boxplot(data=MCTdatafull %>%
                filter(FocalSpecies=="Bi", 
                       Mycotreatment %in% MycoColonization), 
    aes(x=as.character(Competitornum), 
        y=as.numeric(Percol_root), fill=CompetitionTreatment))+
  geom_jitter(width=0.15, color="black", alpha=0.45) +
  facet_wrap(~Mycotreatment)+
  scale_fill_manual(values = Compcolors)+
  labs(x="Competitor density",
       y="EMF % colonization")+
      theme(
        text = element_text(),
        panel.background = element_rect(fill="transparent", colour = NA),
        plot.background = element_rect(fill="transparent",colour = NA),
        panel.border = element_rect(fill="transparent", colour = "black"),
        axis.title.y = element_text(angle=90, size = 12, margin = margin(r=3, unit = "mm")),
        axis.title.x = element_text(size=12, margin = margin(t=3, unit = "mm")),
        axis.text.x = element_text(size=12, margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
        axis.text.y = element_text(size=12, margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
        axis.line = element_blank(),
        axis.ticks.x = element_line(colour = "black"),
        axis.ticks.y = element_line(colour = "black"),
        axis.ticks.length=unit(-1.4, "mm"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_rect(fill="transparent", colour = NA),
            legend.box = "horizontal",
            legend.key.size= unit(4, "mm"),
            legend.text = element_text(size =11),
            legend.spacing = unit(0, "mm"),
            legend.background = element_rect(fill = "transparent", colour = NA),
            plot.margin=margin(t=2, r=2, b=2, l=2, unit = "mm"),
            strip.background=element_rect(fill="transparent", colour=NA),
            strip.text = element_text(face="bold"))




Fullpercolmod<-glm(formula = as.numeric(Percol_root)~CompetitionTreatment+Competitornum+Mycotreatment +(1|TrayNum), data=MCTdatafull %>%
                   filter(FocalSpecies=="Bi", Mycotreatment %in% MycoColonization))

Reducedpercolmod<-glm(formula = as.numeric(Percol_root)~CompetitionTreatment+Competitornum +(1|TrayNum), data=MCTdatafull %>%
                   filter(FocalSpecies=="Bi", Mycotreatment %in% MycoColonization))

anova(Reducedpercolmod,Fullpercolmod)

summary(Reducedpercolmod)


Biomasspercol<-lmer(Totalbiomass_focal~as.numeric(Percol_root)*Mycotreatment*Competitornum*CompetitionTreatment +(1|TrayNum), data=MCTdatafull %>%filter(FocalSpecies=="Bi", Mycotreatment %in% MycoColonization))


Biomasspercolm1<-lmer(Totalbiomass_focal~as.numeric(Percol_root)+Mycotreatment+Competitornum+CompetitionTreatment +(1|TrayNum), data=MCTdatafull %>%filter(FocalSpecies=="Bi", Mycotreatment %in% MycoColonization))

Biomasspercolm2<-lmer(Totalbiomass_focal~as.numeric(Percol_root)+Mycotreatment+Competitornum +(1|TrayNum), data=MCTdatafull %>%filter(FocalSpecies=="Bi", Mycotreatment %in% MycoColonization))

library(performance)
check_model(Biomasspercolm2)

aov(Biomasspercol,Biomasspercolm1, Biomasspercolm2)



BiomassBA<-aov(formula = Totalbiomass_focal~Mycotreatment*Competitornum*CompetitionTreatment +(1|TrayNum), data=MCTdatafull %>%filter(FocalSpecies=="Bi"))

TukeyHSD(Biomasspercol)



modelbiomassreduced<-lm(Totalbiomass_focal~as.numeric(Percol_root)+Mycotreatment, data = MCTdatafull %>% filter(FocalSpecies=="Bi", Mycotreatment %in% MycoColonization))

summary(modelbiomassreduced)



BiomassxColonization<-ggplot()+
  geom_point(data=MCTdatafull %>%
                filter(FocalSpecies=="Bi", 
                       Mycotreatment %in% MycoColonization), 
    aes(x=as.numeric(Percol_root), 
        y=Totalbiomass_focal, color=as.factor(Competitornum), shape=Mycotreatment))+
  stat_smooth(data=MCTdatafull %>%
                filter(FocalSpecies=="Bi", 
                       Mycotreatment %in% MycoColonization),
              aes(x =as.numeric(Percol_root), y = Totalbiomass_focal), 
              method = lm, fullrange = T,
              fill="black", colour="black", size=1, alpha = 0.2)+
  scale_color_manual(values = c("#F5C737","#B4872D"))+
  labs(x="EMF % colonization",
       y="Total biomass (g)")+
      theme(
        text = element_text(),
        panel.background = element_rect(fill="transparent", colour = NA),
        plot.background = element_rect(fill="transparent",colour = NA),
        panel.border = element_rect(fill="transparent", colour = "black"),
        axis.title.y = element_text(angle=90, size = 12, margin = margin(r=3, unit = "mm")),
        axis.title.x = element_text(size=12, margin = margin(t=3, unit = "mm")),
        axis.text.x = element_text(size=12, margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
        axis.text.y = element_text(size=12, margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
        axis.line = element_blank(),
        axis.ticks.x = element_line(colour = "black"),
        axis.ticks.y = element_line(colour = "black"),
        axis.ticks.length=unit(-1.4, "mm"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_rect(fill="transparent", colour = NA),
            legend.box = "horizontal",
            legend.key.size= unit(4, "mm"),
            legend.text = element_text(size =11),
            legend.spacing = unit(0, "mm"),
            legend.background = element_rect(fill = "transparent", colour = NA),
            plot.margin=margin(t=2, r=2, b=2, l=2, unit = "mm"),
            strip.background=element_rect(fill="transparent", colour=NA),
            strip.text = element_text(face="bold"))


```

Root shoot ratios
```{r}
BelowgroundBiomassplot<-ggplot(data=MCTdatafull, aes(x=DensityTreatment,Belowgroundbiomass_focal))+
  geom_boxplot(aes(color=Mycotreatment))+
  labs(title="Biomass by Treatment", 
       x="Treatment",
       y="Biomass")+facet_wrap(~FocalSpecies, scales = "free_y", 
                               ncol=1)
BelowgroundBiomassplot+theme_cowplot()


RootShootBiomassplot<-ggplot(data=MCTdatafull, aes(x=DensityTreatment,Belowgroundbiomass_focal/Abovegroundbiomass_focal))+
  geom_boxplot(aes(color=Mycotreatment))+
  labs(title="Biomass by Treatment", 
       x="Treatment",
       y="Biomass")+facet_wrap(~FocalSpecies, scales = "free_y", 
                               ncol=1)
RootShootBiomassplot+theme_cowplot()

centeredBiomass<-filter(MCTdatafull, Competitornum==0,
        Mycotreatment == "AMF" | Mycotreatment == "EMF" | Mycotreatment == "AMFEMF")%>%
        mutate(
        Masscentered=
        if (FocalSpecies=="Bi"){
        (Totalbiomass_focal- M0bi_sterile)}
        else{ 
         (Totalbiomass_focal- M0ba_sterile)})
      

FOCAL_SPECIES<-c("Ba", "Bi") 
MYCO_TREATMENT<-c("AMF","EMF","AMFEMF","Sterile")
COMPETITOR_TREATMENT<-c("Conspecific", "Heterospecific")
COMPETITOR_NUMBER<-c("0", "1", "4", "8")


library(magicfor)               # load library
magic_for(silent = TRUE) # call magic_for()

  for (i in 1:length(FOCAL_SPECIES)){
      focal <- FOCAL_SPECIES[i]
    for (l in 1: length(COMPETITOR_NUMBER)){
       compnum<- COMPETITOR_NUMBER[l]
      
          MCTdatafull_std=
            MCTdatafull%>%
            filter(FocalSpecies==FOCAL_SPECIES[i],
              Competitornum==COMPETITOR_NUMBER[l])%>%
                  mutate(
                    sterilecon=
                      mean(MCTdatafull$Totalbiomass_focal[MCTdatafull$Mycotreatment=="Sterile"&
                                                  MCTdatafull$CompetitionTreatment=="Conspecific"&
                                                    MCTdatafull$Competitornum==COMPETITOR_NUMBER[l]&
                                                    MCTdatafull$FocalSpecies==FOCAL_SPECIES[i]]),
                    sterilehetero=
                      mean(MCTdatafull$Totalbiomass_focal[MCTdatafull$Mycotreatment=="Sterile"&
                                                  MCTdatafull$CompetitionTreatment=="Heterospecific"&
                                                    MCTdatafull$Competitornum==COMPETITOR_NUMBER[l]&
                                                    MCTdatafull$FocalSpecies==FOCAL_SPECIES[i]]),
                    std_biomass=
                    if (CompetitionTreatment=="Heterospecific"){
                        (Totalbiomass_focal- sterilehetero)}
                       else{ 
                          (Totalbiomass_focal- sterilecon)})
          
         put (MCTdatafull_std)
}}
magic_result_as_dataframe()             

Biomassplotalone<-ggplot(data=filter(MCTdatafull_std),
                         aes(x=Mycotreatment,std_biomass))+
    geom_violin(aes(fill=Mycotreatment)) +
    geom_hline(yintercept = 0)+
    geom_jitter(width=0.15, color="black", alpha=0.45) +
    labs(x="Mycorrhizal Treatment",
       y="Biomass (g)")+
    facet_wrap(~FocalSpecies, scales = "free_y", ncol = 2)+
      scale_fill_manual(values = Mycocolors)+
      theme(
        text = element_text(),
        panel.background = element_rect(fill="transparent", colour = NA),
        plot.background = element_rect(fill="transparent",colour = NA),
        panel.border = element_rect(fill="transparent", colour = "black"),
        axis.title.y = element_text(angle=90, size = 12, margin = margin(r=3, unit = "mm")),
        axis.title.x = element_text(size=12, margin = margin(t=3, unit = "mm")),
        axis.text.x = element_text(size=12, margin = unit(c(t = 2.5, r = 0, b = 0, l = 0), "mm")),
        axis.text.y = element_text(size=12, margin = unit(c(t = 0, r = 2.5, b = 0, l = 0), "mm")),
        axis.line = element_blank(),
        axis.ticks.x = element_line(colour = "black"),
        axis.ticks.y = element_line(colour = "black"),
        axis.ticks.length=unit(-1.4, "mm"), 
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "none")

Alone<-dplyr::filter(MCTdatafull,Competitornum==0)
BiomassaovBi<-(aov(Alone$Totalbiomass_focal[Alone$FocalSpecies=="Bi"]~Alone$Mycotreatment[Alone$FocalSpecies=="Bi"]))

TukeyHSD(BiomassaovBi)


BiomassaovBa<-(aov(MCTdatafull$Totalbiomass_focal[MCTdatafull$FocalSpecies=="Ba"]~MCTdatafull$Mycotreatment[MCTdatafull$FocalSpecies=="Ba"]))

TukeyHSD(BiomassaovBa)


```